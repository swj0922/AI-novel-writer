优化core_seed_prompt
替换character_dynamics_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 核心种子：{core_seed}

请设计3-6个具有动态变化潜力的核心角色，每个角色需包含：
特征：
- 背景、外貌、性别、年龄、职业等
- 暗藏的秘密或潜在弱点(可与世界观或其他角色有关)

核心驱动力三角：
- 表面追求（物质目标）
- 深层渴望（情感需求）
- 灵魂需求（哲学层面）

角色弧线设计：
初始状态 → 触发事件 → 认知失调 → 蜕变节点 → 最终状态

关系冲突网：
- 与其他角色的关系或对立点
- 与至少两个其他角色的价值观冲突
- 一个合作纽带
- 一个隐藏的背叛可能性

要求：
仅给出最终文本，不要解释任何内容。
"""

summary_prompt中的global_summary没找到

文档召回由3改到1（可以考虑召回3，rerank1）

新增一个最终修改agent

加入enable——thinking=false

判断章节之间是否连贯

构建一个评论agent（章节是否连续，章节重复度，情节是否有逻辑性，开头，结局）

针对评论，利用llm进行修改

针对章与章之间存在重复内容：
1.将一章字数从1500降至1200
原因:每一章创建时，需要传入前面三章的完整内容，减少字数有助于模型再创作时专注于新内容的创作，而不是重复原有内容
2.在提示词中强调章与章之间不要有大量重复内容
3.删除伏笔埋设
4.取消知识库的应用

构建一个prompt修改agent，针对具体题材，给出更合适的prompt
将已有prompt_definitions改名，用新生成的prompt文件改成prompt_definitions

如果prompt遵循有问题，可以增加简单例子
不开启思考模型，qwen-flash遵循prompt能力差，改用gemini-pro


===========================================================
需要针对主题修改的prompt
core_seed_prompt
character_dynamics_prompt
world_building_prompt
plot_architecture_prompt 

无需针对主题修改的prompt
summarize_recent_chapters_prompt
chapter_blueprint_prompt
chunked_chapter_blueprint_prompt
summary_prompt
create_character_state_prompt
update_character_state_prompt
first_chapter_draft_prompt
next_chapter_draft_prompt
===========================================================

修改各个文件的from prompt_defination


character_state.txt文件有问题
为什么有了character_dynamics_prompt还要有
create_character_state_prompt,它的作用是什么？

========================
使用异步更新前文摘要，角色状态
========================

生成角色文档考虑用pro

gemini-2.5-pro思考开启high模式

更新角色状态可以用flash


======================================
模型能力
gemini-2.5-flash
优点：
1.写作能力感觉比较强（感觉）

缺点：
1.容易超字数，指定1000，生成1900多
2.会出现某一章节字数异常多的情况（4000多），原因是把上一章节的内容重复输出了一遍
3.生成时间随章节数逐渐增加，从1-2分钟，增加到5-7分钟，且生成时间不稳定
4.偶尔出现中文中夹杂两个英文单词

qwen-flash
优点：
1.速度快，1分钟不到写一章
2.比较不太会超字数，平均超出设置200字左右

缺点：
1.文本能力相比之下稍弱

gemini-2.5-pro
缺点：稳定性差，经常返回None
========================================


在最终gen_novel中提供chunk_size和limit_chapters两个参数



next_chapter_draft_prompt太长了，思考能否简化

在生成第一章的prompt中，加入下一章信息

character_state生成不稳定，总是加入summary

=====================
character_state,限制性格的修改，身体状态和心里状态只描述当前的状态。
=====================


======================
发现这样一种情况：
比如第25和26章：
第26章会重复出现第25章结尾的情况
推测是由于传入了第25章的结尾400字。
=======================


删除角色状态中的身体状态与心理状态

不用更新角色性格与背景

修改世界观prompt，在生成世界观时加入角色信息作为参考

思考三幕式情节是过于束缚剧情发展

前十章的章节目录似乎容易直接进入结尾

生成完毕后，传入50章所有信息，判断剧情是否重复

有些prompt只改了根据言情小说优化的prompt，没改原始prompt


对格式进行优化│  ├──很占字符
角色一：张三
├──特点
│  ├──性格：开朗、有活力，喜欢与他人互动
│  ├──背景与外貌：来自农村的普通男孩，外表普通
├──主要角色间关系网
│  ├──李四：张三从小就与她有关联，对她的成长一直保持关注
│  └──王二：两人之间有着复杂的过去，最近因一场冲突而让对方感到威胁
├──触发或加深的事件
│  ├──村庄内突然出现不明符号：这个不明符号似乎在暗示柳溪镇即将发生重大事件
│  └──李四被刺穿皮肤：这次事件让两人意识到对方的强大实力，促使他们迅速离开队伍

角色二：[角色名称]
...（以此类推）

每20章进行一次character_summary

2025/8/25：可以考虑每过几十章，对触发和加深的事件的前二十条进行总结，不满二十条则不管

redis记录api使用次数，
mysql生成时间，token消耗


ChatCompletion(id='8lCtaPCUGPvRz7IPisO0uAM', choices=[Choice(finish_reason='stop', index=0, logprobs=None, message=ChatCompletionMessage(content='当前章节摘要: 承继前章家庭压力下的暂时联盟，本章的冲突焦点迅速转移至职场。一直蛰伏的竞争对手林澈，抓住并购案中的复杂环节，不再满足于言语试探，而是精心设下一个隐蔽的商业陷阱。他利用专业信息差，故意误导顾清霜，试图诱使其在关键决策上犯下致命错误，从而彻底摧毁她的职业声誉。\n\n陷阱的发展不仅将顾清霜推向了事业的悬崖边缘，更是一场针对陆衍的精准打击。林澈此举的深层目的，是向所有人证明，顾清霜选择的“咖啡师男友”在真正的商业危机面前毫无用处，以此来瓦解她在情感与事业上建立起的双重防线。\n\n面对这场突如其来的、关乎职业生涯的重大危机，顾清霜陷入了孤立无援的境地。这为下一章她对陆衍产生更深层次的依赖，以及由此引发的内心挣扎与情感防御机制的冲突，做好了充足的铺垫。', refusal=None, role='assistant', annotations=None, audio=None, function_call=None, tool_calls=None))], created=1756188914, model='gemini-2.5-pro', object='chat.completion', service_tier=None, system_fingerprint=None, usage=CompletionUsage(completion_tokens=237, prompt_tokens=4916, total_tokens=7214, completion_tokens_details=None, prompt_tokens_details=PromptTokensDetails(audio_tokens=None, cached_tokens=4065)))

prompt示例:
- 29岁生日临近，在母亲的最后通牒下（下周六外婆寿宴），内心焦灼绝望，感到被传统、世俗与“完美女儿”标签压得喘不过气，理性与掌控感彻底崩塌。
- 在极度绝望中，回想起陆衍在“旧时光”咖啡馆的温和与洞察力，将其视为打破僵局的“变数”和“救火队员”，决定启用“雇佣协议”寻找假扮男友。
- 面对家族重压和失控的人生，她试图用金钱和契约掌控局面，将陆衍这个“变数”纳入轨道，将“雇佣协议”视为一场绝望的反击。
- 她以律师的严谨拟定“雇佣协议”条款，并在“旧时光”咖啡馆亲自向陆衍提出邀请，要求他假扮男伴出席外婆寿宴，并支付市场价五倍酬金。
- 收到陆衍的回复邮件，他不仅将酬金翻了三倍至十五倍，更提出了包括肢体接触、亲密称谓等在内的“情侣互动”附加条款。这让顾清霜原本的掌控感瞬间崩塌，感到个人底线受到挑战，并开始重新评估陆衍的动机和真实身份，意识到这场“雇佣”已演变为一场博弈，内心涌起一丝不被察觉的好奇。
- 陆衍提出“补充条款”后，她的愤怒、挣扎与最终妥协，让陆衍在她坚硬的外壳上撕开一道裂缝，她感到前所未有的失控与迷茫。
- 因初恋失败对感情产生不信任，决定用理智和事业构筑壁垒。
- 常去“旧时光”咖啡馆，点黑咖啡，不加糖不加奶，习惯在固定位置工作，表现出高冷与专注，但偶尔流露疲惫。
- 与陆衍在“旧时光”咖啡馆面谈，就补充条款进行协商。尽管她试图挽回主动权，但陆衍步步为营，巧妙地将“情侣互动”的界限推向更有利于“表演真实性”的方向，包括保留特定情境下主动肢体接触的权利、接受“清霜”和“陆衍”的亲密称谓，并提出在寿宴前进行多次“约会”以培养默契。最终，她签订了这份让她感到前所未有失控感的“假扮情侣”合同，内心对陆衍的真实意图和神秘身份的好奇萌芽滋生。
- 感到与陆衍签订的合同如无形枷锁，失去掌控感，陆衍玩味的眼神仍在脑海中盘旋。
- “脱单”消息在律所不胫而走，引来同事探究目光。
- 面对林澈的试探和“关心”，感到不适和警惕，明确表示不喜欢被审视。
- 接到顾夫人电话，被其威严审问与不屑态度压迫，感到无力与窒息。
- 在林澈的步步紧逼和顾夫人的强势施压下，感到前所未有的疲惫和被推入更深漩涡。
- 对陆衍的好奇心在重重压力下不减反增，甚至带有一丝期待，意识到需尽快与陆衍沟通。
- 挽着陆衍踏入宴会厅，面对家族审视，内心紧张不安。

-在29岁生日与母亲的催婚压力下，顾清霜感到极度绝望，决定雇佣一位假扮男友来应对家族的最后通牒。
-她以严谨的律师身份与陆衍签订“雇佣协议”，但陆衍提出更高酬金和更多“情侣互动”的补充条款，打破了她的掌控感。
-尽管内心挣扎，但面对家族重压和前男友林澈的试探，她最终妥协，接受了这份让她感到失控的“假扮情侣”合同。
-在与陆衍的多次接触和博弈中，她对陆衍的真实意图和神秘身份产生了好奇。
-随着她带着陆衍参加外婆寿宴，这场假扮男友的雇佣关系正逐渐演变成一场充满不确定性的博弈。

在chapter.py文件中，最后一章结尾用了长度截取，改成语义截取

设置一个预警，如果没有检查到格式，则终止


输出格式示例：
第n章 - [标题]
本章定位：[角色/事件/主题/...]
核心作用：[推进/转折/揭示/...]
悬念密度：[紧凑/渐进/爆发/...]
本章简述：[简短而精确地概括]

将悬念密度，修改为章节节奏，加入平缓，引入等

发现每一章的叙述容易相似，修改为在创建后一章时，提供前一章的完整文本内容而非仅提供结尾部分内容。

添加退出机制，检测不到格式时，退出终端

问题：
章节5截断
结尾铺垫生硬。
有重复内容出现
有些结尾直接了当的说，为什么埋下伏笔。
章节目录，第二十章苏明远从未认识过李凡，突然认识了

仅根据剧情plot设计目录，减少传入token

尝试使用pro扩展目录


在总结角色文档时：注意角色名称，组织名称，书名，公司名称，机构名称不要省略了。

考虑给出更多的章节目录上下文


按照每一部分创作章节目录，考虑加一个关键事件进展在章节目录中。
加入一个剧情指导，对于已经生成好的第一到第五部分，指导模型加入反转的元素

根据摘要判读本章主要出场角色，只提取角色文档中的主要出场角色

将悬念密度改成：主线，支线，日常。日常就是描述情侣互动

同时使用多个模型生成plot，供用户选择

将性格，背景与外貌统一设定为人物设定

对每章进行概况，每次输入五章的概况